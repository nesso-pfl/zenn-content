---
title: "MSW x Aspida ã§å‹å®‰å…¨ãª API ãƒ¢ãƒƒã‚¯ã‚’å®šç¾©ã™ã‚‹"
emoji: "ğŸ§©"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["TypeScript"]
published: false
---

MSW ã¨ Aspida ã‚’çµ„ã¿åˆã‚ã›ãŸã¨ãã«ã€API ã®ãƒ‘ã‚¹ã‚„ãƒ¡ã‚½ãƒƒãƒ‰ã«å¿œã˜ã¦ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®å‹ã‚’æ¨è«–ã•ã›ã‚‹æ–¹æ³•ã‚’ç´¹ä»‹ã—ã¾ã™ã€‚

## å‰æçŸ¥è­˜
- [MSW](https://mswjs.io/)(Mock Service Worker)
  - ç´¹ä»‹è¨˜äº‹: https://zenn.dev/takepepe/articles/msw-driven-development
- [Aspida](https://github.com/aspida/aspida)
  - ç´¹ä»‹è¨˜äº‹: https://zenn.dev/solufa/articles/getting-started-with-aspida

## ä½•ã‚‚è€ƒãˆãšãƒ¢ãƒƒã‚¯ã‚’å®šç¾©ã—ãŸã¨ãã«èµ·ã“ã‚‹å‹å®‰å…¨æ€§ã®å•é¡Œ
ã¾ãšã€ä»¥ä¸‹ã®ã‚ˆã†ãª Aspida ã‚’åˆ©ç”¨ã—ãŸ API ã®å®šç¾©ãŒã‚ã‚‹ã¨ã—ã¾ã™ã€‚

```ts:api/sample/index.ts
import { DefineMethods } from 'aspida'

type User = {
  id: number
  name: string
}

export type Methods = DefineMethods<{
  get: {
    query?: {
      limit: number
    }
    resBody: User[]
  }

  post: {
    reqBody: {
      name: string
    }
    resBody: User
  }
}>
```

`/sample` ã«å¯¾ã—ã¦ GET ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ã‚‹ã¨ã€`User[]` å‹ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒè¿”ã£ã¦ãã¾ã™ã€‚
ä¸€æ–¹ POST ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ã‚‹ã¨ã€`User` å‹ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒè¿”ã£ã¦ãã¾ã™ã€‚
ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®å®šç¾©ã‚‚ã‚ã‚Šã¾ã™ãŒã€ä»Šå›ã¯ãƒ¢ãƒƒã‚¯ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®ä½œæˆãŒç›®çš„ãªã®ã§ç„¡è¦–ã—ã¦ã‚ˆã„ã§ã™ã€‚

ã“ã® API ã«å¯¾ã—ã¦ã€é€šå¸¸ä»¥ä¸‹ã®ã‚ˆã†ãªãƒ¢ãƒƒã‚¯ã‚’å®šç¾©ã™ã‚‹ã¨æ€ã„ã¾ã™(èª¬æ˜ã®ãŸã‚ã€å¤šå°‘ç°¡å˜ã«ã—ã¦ã„ã¾ã™)ã€‚

```ts:handler.ts
import { DefaultBodyType, rest } from 'msw'
import aspida from '@aspida/axios'
import api from './api/$api'
import axios from 'axios'

const apiClient = api(aspida(axios))

type Method = keyof typeof rest
// ã‚ˆã‚Šå³å¯†ã«å‹ã‚’å®šç¾©ã—ãŸã„å ´åˆ
// type Method = Pick<keyof typeof rest, 'get' | 'post'>

// MSW ã® ctx.json ã®å¼•æ•°ã®å‹ã¯ DefaultBodyType ã§å®šç¾©ã•ã‚Œã¦ã„ã‚‹
const createHandler = (path: string, method: Method, response?: DefaultBodyType) =>
  rest[method](path, (_, res, ctx) => {
    return res(ctx.json(response))
  })

export const handlers = [
  createHandler(apiClient.sample.$path(), 'get', [{ id: 1, name: 'foo' }]),
  // User[] å‹ã§ãªã„ã®ã§ã‚¨ãƒ©ãƒ¼ã‚’æ¤œçŸ¥ã—ã¦ã»ã—ã„
  createHandler(apiClient.sample.$path(), 'get', 'omg'),
  createHandler(apiClient.sample.$path(), 'post', { id: 1, name: 'foo' }),
  // User å‹ã§ãªã„ã®ã§ã‚¨ãƒ©ãƒ¼ã‚’æ¤œçŸ¥ã—ã¦ã»ã—ã„
  createHandler(apiClient.sample.$path(), 'post', { id: 'omg', name: 'foo' }),
]
```

`createHandler` ã¯ API ã®ãƒ‘ã‚¹ãƒ»ãƒ¡ã‚½ãƒƒãƒ‰ãƒ»ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’æ¸¡ã™ã“ã¨ã§ MSW ã®ãƒ¢ãƒƒã‚¯ãƒãƒ³ãƒ‰ãƒ©ã‚’ä½œæˆã™ã‚‹é–¢æ•°ã§ã™ã€‚
ã‚³ãƒ¼ãƒ‰ã‚³ãƒ¡ãƒ³ãƒˆã«ã‚ã‚‹é€šã‚Šã€`createHandler` ã¯å‹å®‰å…¨æ€§ã‚’ä¿è¨¼ã—ã¦ãã‚Œã¾ã›ã‚“ã€‚
`/sample` ã«å¯¾ã—ã¦ GET ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ã‚‹ã¨ã€`string` å‹ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒè¿”ã‚‹ãƒãƒ³ãƒ‰ãƒ©ãŒä½œæˆã§ãã¦ã—ã¾ã„ã¾ã™ã€‚

## ãƒ‘ã‚¹ãƒ»ãƒ¡ã‚½ãƒƒãƒ‰ã«å¿œã˜ã¦ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®å‹ã‚’æ¨è«–ã•ã›ã‚‹

```ts:handler.ts
import { DefaultBodyType, rest } from 'msw'
import aspida from '@aspida/axios'
import api from './api/$api'
import axios from 'axios'

const apiClient = api(aspida(axios))

type Method = keyof typeof rest

type Api<M extends Method, R extends DefaultBodyType> = {
  $path: () => string
  // ãƒ¢ãƒƒã‚¯ä½œæˆã«ã‚ãŸã£ã¦ã¯ã€query ã‚„ body ã®å‹ã¯æ°—ã«ã—ãªã„ã®ã§ any ã§å®šç¾©
  // eslint-disable-next-line @typescript-eslint/no-explicit-any
} & Record<`$${M}`, (args: any) => Promise<R>>

const createHandler = <M extends Method, R extends DefaultBodyType>(path: Api<M, R>, method: M, response?: R) =>
  rest[method](path.$path(), (_, res, ctx) => {
    return res(ctx.json(response))
  })

export const handlers = [
  createHandler(apiClient.sample, 'get', [{ id: 1, name: 'foo' }]),
  // @ts-expect-error User[] å‹ã§ãªã„ã®ã§ã‚¨ãƒ©ãƒ¼
  createHandler(apiClient.sample, 'get', 'omg'),
  createHandler(apiClient.sample, 'post', { id: 1, name: 'foo' }),
  // @ts-expect-error User å‹ã§ãªã„ã®ã§ã‚¨ãƒ©ãƒ¼
  createHandler(apiClient.sample, 'post', { id: 'omg', name: 'foo' }),
  // @ts-expect-error ã‚‚ã¡ã‚ã‚“å­˜åœ¨ã—ãªã„ãƒ¡ã‚½ãƒƒãƒ‰ã‚’æŒ‡å®šã—ãŸå ´åˆã‚‚ã‚¨ãƒ©ãƒ¼
  createHandler(apiClient.sample, 'put'),
]
```

`Api` å‹ã¯ã€å¯¾è±¡ã® API ã«ãŠã„ã¦ä¾‹ãˆã° GET ãƒªã‚¯ã‚¨ã‚¹ãƒˆã§ã‚ã‚Œã°

- `$path` é–¢æ•°ãŒ API ãƒ‘ã‚¹ã‚’è¿”ã™ã“ã¨
- `$get` é–¢æ•°ãŒ API ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’éåŒæœŸã§è¿”ã™ã“ã¨

ã‚’ç¤ºã—ã¾ã™ã€‚

`M` å‹ã¯å¿…ãšãƒ¡ã‚½ãƒƒãƒ‰åã«ãªã‚‹ã‚ˆã†ã« `M extends Method` ã¨ã—ã¦ã„ã¾ã™ã€‚
ã¾ãŸã€`R` (Response) å‹ã¯ MSW ã® `ctx.json` é–¢æ•°ã«ãƒ•ã‚£ãƒƒãƒˆã•ã›ã‚‹ãŸã‚ `R extends DefaultBodyType` ã¨ã—ã¦ã„ã¾ã™ã€‚
`Record` å‹ã®ä¸­èº«ã® `$${M}` ã¯ã±ã£ã¨è¦‹ã‚„ã‚„ã“ã—ã„ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ãŒã€

- `` `${M}` `` ã¯ `M` å‹ã®æ–‡å­—åˆ—ãƒªãƒ†ãƒ©ãƒ«å‹
- ä¾‹ãˆã° `M` ãŒ `'get'` ã§ã‚ã‚Œã°`'get'` ã¨ã„ã†å‹ã«ãªã‚‹
- `` `$${M}` `` ãªã‚‰ã° `'$get'` ã¨ã„ã†å‹ã«ãªã‚‹

ã¨ã„ã†é¢¨ã«ãªã£ã¦ã„ã¾ã™ã€‚
ã“ã® `Api` å‹ã‚’ `createHandler` é–¢æ•°ã§åˆ©ç”¨ã™ã‚‹ã“ã¨ã«ã‚ˆã‚Šã€ãƒ‘ã‚¹ãƒ»ãƒ¡ã‚½ãƒƒãƒ‰ã«å¿œã˜ã¦ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®å‹ã‚’æ¨è«–ã•ã›ã‚‹ã“ã¨ãŒã§ãã¾ã—ãŸã€‚

## Appendix: å‹æ¨è«–ã®æµã‚Œ